<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æŠ•è³‡æ“ä½œ</title>
    <style>
        :root {
            --ios-bg: #f2f2f7; --ios-card: #ffffff;
            --ios-blue: #007aff; --ios-green: #34c759; --ios-red: #ff3b30;
            --ios-gray: #8e8e93; --ios-input-bg: #e5e5ea;
            --ios-text: #000000;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; 
            margin: 0; padding: 16px; background: var(--ios-bg); color: var(--ios-text); padding-bottom: 80px; 
            -webkit-font-smoothing: antialiased;
        }
        .card { background: var(--ios-card); padding: 16px; margin-bottom: 16px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        select, input { width: 100%; padding: 12px; border: none; border-radius: 10px; background: var(--ios-input-bg); font-size: 17px; margin-bottom: 8px; box-sizing: border-box; outline: none; -webkit-appearance: none; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .info-box { background: var(--ios-input-bg); padding: 12px; border-radius: 12px; text-align: center; }
        .info-label { font-size: 13px; color: var(--ios-gray); margin-bottom: 4px; }
        .info-val { font-size: 20px; font-weight: 700; color: var(--ios-blue); letter-spacing: -0.5px; }
        .trade-row { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
        button { flex: 1; padding: 12px; border: none; font-weight: 600; color: white; border-radius: 12px; font-size: 15px; cursor: pointer; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        .btn-buy { background: var(--ios-green); } .btn-sell { background: var(--ios-red); }
        .btn-action { background: var(--ios-blue); width: 100%; }
        .btn-disabled { background: var(--ios-input-bg); color: var(--ios-gray); pointer-events: none; }
        .tag { font-size: 11px; padding: 4px 8px; border-radius: 100px; color: white; margin-left: 6px; font-weight: 600; vertical-align: middle;}
        .tag-stock { background: #5856d6; } .tag-gold { background: #ff9500; } .tag-bond { background: #34c759; }
        .text-up { color: var(--ios-green); } .text-down { color: var(--ios-red); } 
        .price-change { font-size: 13px; font-weight: 500; }
        .deposit-item { border-bottom: 1px solid #efefef; padding: 12px 0; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        #news-modal, #end-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-card { background: var(--ios-card); width: 85%; max-width: 400px; padding: 24px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(50,50,50,0.9); color: white; padding: 12px 24px; border-radius: 50px; display: none; z-index: 100; font-size: 14px; font-weight: 600; }
        .bond-info { font-size: 11px; color: var(--ios-green); background: rgba(52, 199, 89, 0.1); padding: 4px 8px; border-radius: 6px; display: inline-block; margin-top: 4px; }
    </style>
</head>
<body>
    <div id="news-modal"><div class="modal-card"><div style="font-size: 40px; margin-bottom: 10px;">ğŸ“¢</div><h2 id="modal-title" style="font-size: 20px;">å¿«è¨Š</h2><p id="modal-desc" style="font-size: 16px; color: #333; line-height: 1.4;">...</p><button onclick="document.getElementById('news-modal').style.display='none'" style="background:var(--ios-blue); width:100%; margin-top:10px;">æˆ‘çŸ¥é“äº†</button></div></div>
    <div id="end-screen"><div class="modal-card"><h1>ğŸ‰ éŠæˆ²çµæŸ</h1><p style="color: var(--ios-gray);">æœ€çµ‚çµç®—</p><h1 id="final-assets" style="font-size: 42px; margin: 0 0 20px 0; color: var(--ios-blue);">$0</h1><div id="final-breakdown" style="text-align: left; background: var(--ios-input-bg); padding: 15px; border-radius: 12px; font-size: 14px;"></div></div></div>

    <div id="login-screen" style="height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 20px;">
        <div class="card" style="text-align: center; padding: 40px 20px;">
            <h2 style="margin-bottom: 20px;">è‚¡å¸‚å¤§äº¨</h2>
            <input type="text" id="username" placeholder="è¼¸å…¥å§“å / çµ„åˆ¥" style="text-align: center;">
            <button class="btn-action" style="margin-top: 10px;" onclick="attemptJoin()">é€²å…¥å¸‚å ´</button>
        </div>
    </div>

    <div id="game-screen" style="display:none;">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
                <h1 style="font-size: 28px; font-weight: 800; margin: 0;">æˆ‘çš„è³‡ç”¢</h1>
                <div style="font-size: 13px; color: var(--ios-gray); margin-top: 2px;">
                    <span id="player-name-display"></span> â€¢ <span onclick="logout()" style="color: var(--ios-blue); cursor: pointer;">ç™»å‡º</span>
                </div>
            </div>
            <span id="round-display" style="background: var(--ios-input-bg); padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; color: var(--ios-gray);">è¼‰å…¥ä¸­...</span>
        </div>

        <div class="card">
            <div class="info-grid">
                <div class="info-box"><div class="info-label">ç¾é‡‘</div><div class="info-val" id="p-cash">$0</div></div>
                <div class="info-box"><div class="info-label">ç¸½è³‡ç”¢</div><div class="info-val" id="p-total">$0</div></div>
            </div>
        </div>

        <div class="card">
            <h3 style="color:var(--ios-green); font-size: 18px;">å®šæœŸå­˜æ¬¾</h3>
            <div style="font-size:13px; color:var(--ios-gray); margin-bottom:12px;">è³‡é‡‘é–å®šï¼Œåˆ°æœŸè‡ªå‹•å…¥å¸³ã€‚</div>
            <div style="background:var(--ios-input-bg); padding:12px; border-radius:12px; margin-bottom:15px;">
                <div style="display:flex; gap:8px;">
                    <input type="number" id="deposit-amount" placeholder="é‡‘é¡" style="flex:1; margin:0; background: white;">
                    <select id="deposit-duration" style="flex:1.2; margin:0; background: white;">
                        <option value="3">3å€‹æœˆ (0.125%)</option>
                        <option value="6">6å€‹æœˆ (0.125%)</option>
                        <option value="9">9å€‹æœˆ (0.150%)</option>
                        <option value="12">12å€‹æœˆ (0.150%)</option>
                    </select>
                </div>
                <button class="btn-action" style="background:var(--ios-green); margin-top: 8px;" onclick="createDeposit()">ç«‹å³å­˜å…¥</button>
            </div>
            <div id="deposit-list"></div>
        </div>

        <h3 style="margin: 20px 0 10px 5px; color: var(--ios-gray); font-size: 14px; text-transform: uppercase;">å¸‚å ´å ±åƒ¹</h3>
        <div id="market-list"></div>
    </div>
    <div id="toast"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myData = null, currentMarket = null, currentRound = 0;

        function getUserId() {
            let uid = localStorage.getItem('stockGameUID');
            if (!uid) {
                uid = 'user_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('stockGameUID', uid);
            }
            return uid;
        }

        window.onload = function() {
            const savedName = localStorage.getItem('stockGameUser');
            if (savedName) {
                document.getElementById('username').value = savedName;
                attemptJoin(true);
            }
        };

        function attemptJoin(isAuto = false) {
            const nameInput = document.getElementById('username');
            const name = nameInput.value.trim();
            const uid = getUserId();
            if(name) {
                if(!isAuto) localStorage.setItem('stockGameUser', name);
                socket.emit('join_game', 'player', { name: name, userId: uid });
            }
        }

        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦æ¸…é™¤ç´€éŒ„å—ï¼Ÿ")) {
                localStorage.removeItem('stockGameUser');
                window.location.reload();
            }
        }

        socket.on('login_failed', (msg) => {
            alert(msg);
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('game-screen').style.display = 'none';
            localStorage.removeItem('stockGameUser');
        });

        socket.on('init_player', data => { 
            if(data.reload) window.location.reload();
            currentRound = data.round;
            document.getElementById('player-name-display').innerText = data.player.name;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            updateAll(data); 
            if(data.lastEvent) showNews(data.lastEvent); 
        });

        socket.on('update_player', data => { updateAll({ player: data.player, market: currentMarket }); if(data.msg) showToast(data.msg); });
        socket.on('error_msg', msg => showToast(msg));
        
        socket.on('new_round', data => {
            currentMarket = data.market;
            currentRound = data.round;
            document.getElementById('round-display').innerText = `Round ${data.round} (${data.round*3}m)`;
            renderMarket();
            if(myData) renderDeposits(myData.deposits); 
            if(data.event) showNews(data.event);
        });

        socket.on('game_over', data => {
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('news-modal').style.display = 'none';
            let me = data.players[socket.id] || myData;
            let stockVal = 0;
            for(let code in me.portfolio) if(data.market[code]) stockVal += me.portfolio[code] * data.market[code].price;
            let depositTotal = 0;
            if(me.deposits) me.deposits.forEach(d => depositTotal += d.amount);
            let total = me.cash + depositTotal + stockVal;
            document.getElementById('final-assets').innerText = '$' + Math.floor(total).toLocaleString();
            document.getElementById('final-breakdown').innerHTML = `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>ç¾é‡‘</span> <span>$${Math.floor(me.cash).toLocaleString()}</span></div><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>å®šå­˜</span> <span>$${Math.floor(depositTotal).toLocaleString()}</span></div><div style="display:flex; justify-content:space-between;"><span>è­‰åˆ¸</span> <span>$${Math.floor(stockVal).toLocaleString()}</span></div>`;
            document.getElementById('end-screen').style.display = 'flex';
        });

        function showNews(event) {
            document.getElementById('modal-title').innerText = event.title;
            document.getElementById('modal-desc').innerText = event.desc;
            document.getElementById('news-modal').style.display = 'flex';
        }

        function updateAll(data) {
            myData = data.player;
            if(data.market) currentMarket = data.market;
            if(data.round !== undefined) currentRound = data.round;
            document.getElementById('round-display').innerText = `Round ${currentRound} (${currentRound*3}m)`;
            let stockVal = 0;
            if(currentMarket) { for(let code in myData.portfolio) stockVal += myData.portfolio[code] * currentMarket[code].price; }
            let depositTotal = 0;
            if(myData.deposits) myData.deposits.forEach(d => depositTotal += d.amount);
            let total = myData.cash + depositTotal + stockVal;
            document.getElementById('p-cash').innerText = '$' + Math.floor(myData.cash).toLocaleString();
            document.getElementById('p-total').innerText = '$' + Math.floor(total).toLocaleString();
            renderDeposits(myData.deposits);
            renderMarket();
        }

        function renderDeposits(deposits) {
            const list = document.getElementById('deposit-list');
            if(!deposits || deposits.length === 0) { list.innerHTML = '<div style="text-align:center; color:#999; font-size:13px; padding:10px;">ç›®å‰æ²’æœ‰å®šå­˜</div>'; return; }
            list.innerHTML = deposits.map(d => {
                let roundsLeft = d.maturityRound - currentRound;
                return `<div class="deposit-item"><div><div style="font-weight:600;">$${d.amount.toLocaleString()}</div><div style="font-size:12px; color:#8e8e93;">${d.duration}å€‹æœˆæœŸ</div></div><div style="font-size:12px; font-weight:600; color: ${roundsLeft<=0 ? '#34c759':'#ff9500'}; background: ${roundsLeft<=0 ? 'rgba(52,199,89,0.1)' : 'rgba(255,149,0,0.1)'}; padding:4px 8px; border-radius:6px;">${roundsLeft <= 0 ? "çµç®—ä¸­..." : `ğŸ”’ å‰© ${roundsLeft} å›åˆ`}</div></div>`;
            }).join('');
        }

        function renderMarket() {
            if (!currentMarket) return;
            const list = document.getElementById('market-list');
            list.innerHTML = Object.keys(currentMarket).map(code => {
                const item = currentMarket[code];
                const holdingQty = myData.portfolio[code] || 0;
                const lotsHeld = Math.floor(holdingQty / item.lotSize);
                let costPerLot = item.price * item.lotSize;
                let feeMultiplier = item.type === 'stock' ? 1.004 : 1; 
                let maxBuy = Math.floor(myData.cash / (costPerLot * feeMultiplier));
                if(item.type === 'bond' && (costPerLot < item.minEntry)) { let minLots = Math.ceil(item.minEntry / costPerLot); if (maxBuy < minLots) maxBuy = 0; }
                let unitName = item.type === 'gold' ? 'å…©' : 'æ‰‹';
                let shareUnit = item.type === 'gold' ? 'å…©' : (item.type === 'bond' ? 'å–®ä½' : 'è‚¡');
                let buyOptions = maxBuy === 0 ? `<option value="0">é¤˜é¡ä¸è¶³</option>` : "";
                if (maxBuy > 0) { let limit = Math.min(maxBuy, 100); for(let i=1; i<=limit; i++) buyOptions += `<option value="${i}">${i} ${unitName} ($${Math.floor(i*costPerLot).toLocaleString()})</option>`; }
                let sellOptions = lotsHeld === 0 ? `<option value="0">ç„¡æŒå€‰</option>` : "";
                if (lotsHeld > 0) { let limit = Math.min(lotsHeld, 100); for(let i=1; i<=limit; i++) sellOptions += `<option value="${i}">${i} ${unitName}</option>`; }
                let change = item.change || 0; let pct = item.changePercent || 0;
                let colorClass = change >= 0 ? "text-up" : "text-down";
                let changeDisplay = change !== 0 ? `<span class="price-change ${colorClass}"> ${change>=0?"+":""}${change.toFixed(2)} (${change>=0?"+":""}${pct.toFixed(1)}%)</span>` : `<span class="price-change" style="color:#999">-</span>`;
                let tagType = item.type === 'gold' ? 'gold' : (item.type === 'bond' ? 'bond' : 'stock');
                let tagName = item.type === 'gold' ? 'é»ƒé‡‘' : (item.type === 'bond' ? 'å‚µåˆ¸' : 'è‚¡ç¥¨');
                let extraInfo = item.type === 'bond' ? `<br><span class="bond-info">å¹´æ¯ ${item.coupon}%</span>` : '';
                return `<div class="card"><div style="display:flex; justify-content:space-between; align-items:flex-start;"><div><div style="font-weight:700; font-size:17px;">${item.name} <span class="tag tag-${tagType}">${tagName}</span></div><div style="color:#8e8e93; font-size:13px; margin-top:2px;">${code} ${extraInfo}</div></div><div style="text-align:right;"><div style="font-size:18px; font-weight:700;">$${item.price.toFixed(2)}</div>${changeDisplay}</div></div><div style="background:var(--ios-input-bg); padding:8px 12px; border-radius:8px; font-size:13px; margin: 12px 0; color: #555;">æŒæœ‰: <strong style="color:black;">${holdingQty} ${shareUnit}</strong> (${lotsHeld} ${unitName})</div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;"><div><div class="trade-row"><select id="buy-select-${code}" style="margin:0; background:var(--ios-input-bg);">${buyOptions}</select></div><button class="${maxBuy > 0 ? 'btn-buy' : 'btn-disabled'}" style="width:100%; margin-top:6px;" onclick="trade('buy', '${code}')">è²·å…¥</button></div><div><div class="trade-row"><select id="sell-select-${code}" style="margin:0; background:var(--ios-input-bg);">${sellOptions}</select></div><button class="${lotsHeld > 0 ? 'btn-sell' : 'btn-disabled'}" style="width:100%; margin-top:6px;" onclick="trade('sell', '${code}')">è³£å‡º</button></div></div></div>`;
            }).join('');
        }

        function trade(action, code) {
            const selectId = action === 'buy' ? `buy-select-${code}` : `sell-select-${code}`;
            const val = document.getElementById(selectId).value;
            if(val === "0" || !val) return;
            socket.emit('trade', action, code, parseInt(val));
        }
        function createDeposit() {
            const amt = document.getElementById('deposit-amount').value;
            const dur = document.getElementById('deposit-duration').value;
            if(!amt || amt <= 0) return showToast("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");
            socket.emit('create_deposit', amt, dur);
            document.getElementById('deposit-amount').value = '';
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>