<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŠ•è³‡æ“ä½œ</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 10px; background: #f2f2f7; color: #1c1c1e; padding-bottom: 50px; }
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .info-box { background: #f0f0f5; padding: 10px; border-radius: 8px; text-align: center; }
        .info-val { font-size: 16px; font-weight: bold; color: #007aff; }
        
        select, input { width: 100%; padding: 12px; border: 1px solid #007aff; border-radius: 8px; background: white; font-size: 16px; margin-bottom: 8px; box-sizing: border-box; }
        .trade-row { display: flex; gap: 5px; align-items: center; margin-top: 5px; }
        button { flex: 0.8; padding: 12px; border: none; font-weight: bold; color: white; border-radius: 8px; font-size:14px; }
        .btn-buy { background: #34c759; }
        .btn-sell { background: #ff3b30; }
        .btn-action { background: #007aff; width: 100%; }
        .btn-disabled { background: #ccc; pointer-events: none; }
        
        .tag { font-size: 10px; padding: 2px 5px; border-radius: 4px; color: white; margin-left: 5px; }
        .tag-stock { background: #5856d6; }
        .tag-gold { background: #ff9500; }
        .tag-bond { background: #34c759; }

        .text-up { color: #34c759; } .text-down { color: #ff3b30; } 
        .price-change { font-size: 12px; font-weight: normal; }

        .deposit-item { border-bottom: 1px solid #eee; padding: 8px 0; font-size: 13px; display: flex; justify-content: space-between; }
        
        #news-modal, #end-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); color: white; padding: 20px; z-index: 200; display: none; overflow-y: auto; text-align: center; }
        #news-content { margin-top: 30vh; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; display: none; z-index: 100; }
    </style>
</head>
<body>
    <div id="news-modal">
        <div id="news-content">
            <h2 id="modal-title" style="color: #ffeb3b;">å¸‚å ´å¿«è¨Š</h2>
            <p id="modal-desc" style="font-size:18px;">å…§å®¹...</p>
            <button onclick="document.getElementById('news-modal').style.display='none'" style="background:#2196f3; width:auto; margin-top:20px;">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <div id="end-screen">
        <div style="margin-top: 15vh;">
            <h1 style="color: #ffeb3b;">ğŸ‰ éŠæˆ²çµæŸ ğŸ‰</h1>
            <h3>ä½ çš„æœ€çµ‚è³‡ç”¢</h3>
            <h1 id="final-assets" style="font-size: 40px; margin: 10px 0;">$0</h1>
            <div id="final-breakdown" style="text-align: left; background: #333; padding: 20px; border-radius: 10px; display: inline-block; min-width: 250px;"></div>
        </div>
    </div>

    <div id="login-screen" class="card" style="text-align: center; margin-top: 50px;">
        <h2>æŠ•è³‡å¤§è³½ç™»å…¥</h2>
        <input type="text" id="username" placeholder="è¼¸å…¥å§“å / çµ„åˆ¥">
        <button class="btn-buy" style="width:100%" onclick="joinGame()">é€²å…¥å¸‚å ´</button>
    </div>

    <div id="game-screen" style="display:none;">
        <div class="card">
            <h3 id="round-display">æº–å‚™ä¸­...</h3>
            <div class="info-grid">
                <div class="info-box">ç¾é‡‘<br><span class="info-val" id="p-cash">$0</span></div>
                <div class="info-box">ç¸½è³‡ç”¢<br><span class="info-val" id="p-total">$0</span></div>
            </div>
        </div>

        <div class="card" style="border: 1px solid #c8e6c9; background: #f1f8e9;">
            <h3 style="margin-top:0; color:#2e7d32">å®šæœŸå­˜æ¬¾ (Time Deposit)</h3>
            <div style="font-size:12px; color:#555; margin-bottom:10px;">
                <span style="color:#d32f2f; font-weight:bold;">æ³¨æ„ï¼šå­˜æ¬¾æœŸé–“ç„¡æ³•å–å‡ºã€‚</span><br>
                åˆ°æœŸå¾Œæœ¬é‡‘èˆ‡åˆ©æ¯å°‡è‡ªå‹•å­˜å…¥ç¾é‡‘ã€‚
            </div>
            
            <div style="background:white; padding:10px; border-radius:8px; margin-bottom:10px;">
                <label style="font-size:12px; font-weight:bold;">å»ºç«‹æ–°å®šå­˜:</label>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="number" id="deposit-amount" placeholder="é‡‘é¡" style="flex:1; margin-bottom:0;">
                </div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <select id="deposit-duration" style="flex:1; margin-bottom:0;">
                        <option value="3">3å€‹æœˆ (1å›åˆ) - 0.125% p.a.</option>
                        <option value="6">6å€‹æœˆ (2å›åˆ) - 0.125% p.a.</option>
                        <option value="12">12å€‹æœˆ (4å›åˆ) - 0.150% p.a.</option>
                    </select>
                    <button class="btn-action" style="flex:0.4; background:#2e7d32;" onclick="createDeposit()">å­˜å…¥</button>
                </div>
            </div>

            <div style="font-size:12px; font-weight:bold; color:#555;">ç”Ÿæ•ˆä¸­çš„å®šå­˜ (ç„¡æ³•æ‰‹å‹•å–å‡º):</div>
            <div id="deposit-list">
                <div style="text-align:center; color:#999; padding:10px;">ç„¡</div>
            </div>
        </div>

        <div id="market-list"></div>
    </div>
    <div id="toast"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myData = null, currentMarket = null, currentRound = 0;

        function joinGame() {
            const name = document.getElementById('username').value;
            if(name) {
                socket.emit('join_game', 'player', name);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'block';
            }
        }

        socket.on('init_player', data => { 
            if(data.reload) window.location.reload();
            currentRound = data.round;
            updateAll(data); 
            if(data.lastEvent) showNews(data.lastEvent); 
        });

        socket.on('update_player', data => { updateAll({ player: data.player, market: currentMarket }); if(data.msg) showToast(data.msg); });
        socket.on('error_msg', msg => showToast(msg));
        
        socket.on('new_round', data => {
            currentMarket = data.market;
            currentRound = data.round;
            document.getElementById('round-display').innerText = `ç¬¬ ${data.round} å›åˆ (ç´¯è¨ˆ ${data.round*3} å€‹æœˆ)`;
            renderMarket();
            if(myData) renderDeposits(myData.deposits); // æ›´æ–°å®šå­˜å€’æ•¸
            if(data.event) showNews(data.event);
        });

        socket.on('game_over', data => {
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('news-modal').style.display = 'none';
            
            let me = data.players[socket.id] || myData;
            
            // è¨ˆç®—æœ€çµ‚è³‡ç”¢
            let stockVal = 0;
            for(let code in me.portfolio) if(data.market[code]) stockVal += me.portfolio[code] * data.market[code].price;
            
            // å®šå­˜æœ¬é‡‘ç®—å…¥è³‡ç”¢
            let depositTotal = 0;
            if(me.deposits) me.deposits.forEach(d => depositTotal += d.amount);

            let total = me.cash + depositTotal + stockVal;

            document.getElementById('final-assets').innerText = '$' + Math.floor(total).toLocaleString();
            document.getElementById('final-breakdown').innerHTML = `
                <p>ç¾é‡‘çµé¤˜: $${Math.floor(me.cash).toLocaleString()}</p>
                <p>å®šå­˜æœ¬é‡‘ (é–å®šä¸­): $${Math.floor(depositTotal).toLocaleString()}</p>
                <p>è­‰åˆ¸å¸‚å€¼: $${Math.floor(stockVal).toLocaleString()}</p>
            `;
            document.getElementById('end-screen').style.display = 'block';
        });

        function showNews(event) {
            document.getElementById('modal-title').innerText = "ğŸ“¢ " + event.title;
            document.getElementById('modal-desc').innerText = event.desc;
            document.getElementById('news-modal').style.display = 'block';
        }

        function updateAll(data) {
            myData = data.player;
            if(data.market) currentMarket = data.market;
            if(data.round !== undefined) currentRound = data.round;
            
            document.getElementById('round-display').innerText = `ç¬¬ ${currentRound} å›åˆ`;

            let stockVal = 0;
            if(currentMarket) {
                for(let code in myData.portfolio) stockVal += myData.portfolio[code] * currentMarket[code].price;
            }
            
            let depositTotal = 0;
            if(myData.deposits) myData.deposits.forEach(d => depositTotal += d.amount);

            let total = myData.cash + depositTotal + stockVal;
            document.getElementById('p-cash').innerText = '$' + Math.floor(myData.cash).toLocaleString();
            document.getElementById('p-total').innerText = '$' + Math.floor(total).toLocaleString();
            
            renderDeposits(myData.deposits);
            renderMarket();
        }

        function renderDeposits(deposits) {
            const list = document.getElementById('deposit-list');
            if(!deposits || deposits.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#999; padding:10px;">ç„¡</div>';
                return;
            }
            list.innerHTML = deposits.map(d => {
                let roundsLeft = d.maturityRound - currentRound;
                return `
                <div class="deposit-item">
                    <div>
                        <strong>$${d.amount.toLocaleString()}</strong> <span style="color:#666">(${d.duration}å€‹æœˆ)</span>
                    </div>
                    <div style="color: ${roundsLeft<=0 ? 'green':'#e65100'}; font-weight:bold;">
                        ${roundsLeft <= 0 ? "å³å°‡å…¥å¸³" : `ğŸ”’ é–å®šä¸­ (å‰© ${roundsLeft} å›åˆ)`}
                    </div>
                </div>`;
            }).join('');
        }

        function renderMarket() {
            if (!currentMarket) return;
            const list = document.getElementById('market-list');
            list.innerHTML = Object.keys(currentMarket).map(code => {
                const item = currentMarket[code];
                const holdingQty = myData.portfolio[code] || 0; // é€™è£¡æ˜¯ã€Œè‚¡æ•¸ã€
                
                // === ä¿®æ­£ï¼šæ¸…æ¥šå€åˆ† è‚¡æ•¸(Shares) èˆ‡ æ‰‹æ•¸(Lots) ===
                const lotsHeld = Math.floor(holdingQty / item.lotSize);
                
                let costPerLot = item.price * item.lotSize;
                let feeMultiplier = item.type === 'stock' ? 1.004 : 1; 
                let maxBuy = Math.floor(myData.cash / (costPerLot * feeMultiplier));
                
                if(item.type === 'bond' && (costPerLot < item.minEntry)) {
                    let minLots = Math.ceil(item.minEntry / costPerLot);
                    if (maxBuy < minLots) maxBuy = 0; 
                }

                let unitName = item.type === 'gold' ? 'å…©' : 'æ‰‹';
                let shareUnit = item.type === 'gold' ? 'å…©' : (item.type === 'bond' ? 'å–®ä½' : 'è‚¡');

                let buyOptions = maxBuy === 0 ? `<option value="0">è³‡é‡‘ä¸è¶³ / æœªé”é–€æª»</option>` : "";
                if (maxBuy > 0) {
                    let limit = Math.min(maxBuy, 20);
                    for(let i=1; i<=limit; i++) buyOptions += `<option value="${i}">${i} ${unitName} ($${Math.floor(i*costPerLot).toLocaleString()})</option>`;
                }

                let sellOptions = lotsHeld === 0 ? `<option value="0">ç„¡æŒå€‰</option>` : "";
                if (lotsHeld > 0) {
                    let limit = Math.min(lotsHeld, 50);
                    for(let i=1; i<=limit; i++) sellOptions += `<option value="${i}">${i} ${unitName}</option>`;
                }

                let change = item.change || 0;
                let pct = item.changePercent || 0;
                let colorClass = change >= 0 ? "text-up" : "text-down";
                let sign = change >= 0 ? "+" : "";
                let changeDisplay = change !== 0 ? `<span class="price-change ${colorClass}"> ${sign}${change.toFixed(2)} (${sign}${pct.toFixed(1)}%)</span>` : `<span class="price-change" style="color:#999">-</span>`;

                let tagType = item.type === 'gold' ? 'gold' : (item.type === 'bond' ? 'bond' : 'stock');
                let tagName = item.type === 'gold' ? 'é»ƒé‡‘' : (item.type === 'bond' ? 'å‚µåˆ¸' : 'è‚¡ç¥¨');
                let lotDisplay = item.type === 'gold' ? "æ¯å…©" : `æ¯æ‰‹ ${item.lotSize} ${shareUnit}`;
                let extraInfo = item.type === 'bond' ? `<div style="font-size:11px; color:#2e7d32; background:#e8f5e9; padding:2px;">å¹´æ¯: ${item.coupon}% | é–€æª»: $${item.minEntry.toLocaleString()}</div>` : '';
                
                return `
                <div class="card">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <strong>${item.name}</strong> <span class="tag tag-${tagType}">${tagName}</span><br>
                            <span style="color:#666; font-size:12px;">ä»£è™Ÿ: ${code}</span>
                            ${extraInfo}
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:18px; font-weight:bold;">$${item.price.toFixed(2)}<br>${changeDisplay}</div>
                            <div style="font-size:12px; color:#666;">${lotDisplay}</div>
                        </div>
                    </div>
                    
                    <div style="background:#f9f9f9; padding:8px; border-radius:4px; font-size:14px; margin: 8px 0;">
                        æŒæœ‰: <strong>${holdingQty} ${shareUnit}</strong> <span style="color:#666; font-size:12px;">(å…± ${lotsHeld} ${unitName})</span>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px;">
                        <div>
                            <div style="font-size:12px; color:#34c759;">è²·å…¥</div>
                            <div class="trade-row">
                                <select id="buy-select-${code}">${buyOptions}</select>
                                <button class="${maxBuy > 0 ? 'btn-buy' : 'btn-disabled'}" onclick="trade('buy', '${code}')">è²·å…¥</button>
                            </div>
                        </div>
                        <div>
                            <div style="font-size:12px; color:#ff3b30;">è³£å‡º</div>
                            <div class="trade-row">
                                <select id="sell-select-${code}">${sellOptions}</select>
                                <button class="${lotsHeld > 0 ? 'btn-sell' : 'btn-disabled'}" onclick="trade('sell', '${code}')">è³£å‡º</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function trade(action, code) {
            const selectId = action === 'buy' ? `buy-select-${code}` : `sell-select-${code}`;
            const val = document.getElementById(selectId).value;
            if(val === "0" || !val) return;
            socket.emit('trade', action, code, parseInt(val));
        }

        function createDeposit() {
            const amt = document.getElementById('deposit-amount').value;
            const dur = document.getElementById('deposit-duration').value;
            if(!amt || amt <= 0) return showToast("è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡");
            socket.emit('create_deposit', amt, dur);
            document.getElementById('deposit-amount').value = '';
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>