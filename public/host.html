<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <title>ç¸½æ§åˆ¶å° - è‚¡å¸‚å¤§äº¨</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #eee; display: flex; height: 100vh; margin: 0; }
        .sidebar { width: 320px; padding: 20px; background: #333; border-right: 1px solid #444; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        
        #news-banner {
            background: #d32f2f; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;
            display: none; animation: flash 1s;
        }
        @keyframes flash { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        #news-title { font-size: 24px; font-weight: bold; margin-bottom: 5px; }

        .stat-box { background: #444; padding: 10px; margin-bottom: 8px; border-radius: 5px; display: flex; justify-content: space-between; font-size: 14px; }
        .tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; color: black; margin-right: 5px;}
        .player-row { background: #333; margin-bottom: 10px; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid transparent; }
        .rank-1 { border-left-color: gold; } .rank-2 { border-left-color: silver; } .rank-3 { border-left-color: #cd7f32; }
        
        button { width: 100%; padding: 15px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-bottom: 5px;}
        .btn-next { background: #2196f3; }
        .btn-stop { background: #ff9800; color: black; font-weight: bold; }
        .btn-reset { background: #b71c1c; margin-top: auto; font-size: 14px; }
        
        .up { color: #4caf50; } .down { color: #f44336; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #login-box { background: #333; padding: 30px; border-radius: 10px; text-align: center; width: 300px; }
        #login-pass { width: 90%; padding: 10px; margin-bottom: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div id="login-box">
            <h2>ç®¡ç†å“¡ç™»å…¥</h2>
            <input type="password" id="login-pass" placeholder="è¼¸å…¥å¯†ç¢¼">
            <button class="btn-next" onclick="attemptLogin()">ç™»å…¥</button>
            <div id="login-err" style="color:red; display:none; margin-top:10px;">å¯†ç¢¼éŒ¯èª¤</div>
        </div>
    </div>

    <div class="sidebar">
        <h2 id="round-title">æº–å‚™éšæ®µ</h2>
        
        <button class="btn-next" onclick="socket.emit('next_round_action')" id="btn-next">é–‹å§‹ Round 1</button>
        <button class="btn-stop" onclick="if(confirm('ç¢ºå®šè¦çµæŸéŠæˆ²å—ï¼Ÿæ‰€æœ‰ç©å®¶å°‡çœ‹åˆ°çµç®—ç•«é¢ã€‚')) socket.emit('end_game_action')" id="btn-stop">ğŸ›‘ çµæŸéŠæˆ²</button>

        <h3>å¸‚å ´å ±åƒ¹</h3>
        <div id="market-list"></div>
        
        <button class="btn-reset" onclick="if(confirm('è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰æ•¸æ“šä¸¦é‡å•Ÿã€‚ç¢ºå®š?')) socket.emit('reset_game')">âš ï¸ é‡ç½®éŠæˆ²</button>
    </div>

    <div class="main">
        <div id="news-banner">
            <div id="news-title">BREAKING NEWS</div>
            <div id="news-desc">...</div>
        </div>
        <h2>æ’è¡Œæ¦œ <span id="status-tag" style="font-size:14px; background:#444; padding:5px; border-radius:5px;">é€²è¡Œä¸­</span></h2>
        <div id="leaderboard"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        function attemptLogin() {
            const pass = document.getElementById('login-pass').value;
            socket.emit('join_game', 'host', pass);
        }

        socket.on('host_login_success', () => { document.getElementById('login-overlay').style.display = 'none'; });
        socket.on('error_msg', (msg) => { document.getElementById('login-err').style.display = 'block'; document.getElementById('login-err').innerText = msg; });

        socket.on('host_update', (data) => {
            document.getElementById('round-title').innerText = data.round === 0 ? "æº–å‚™éšæ®µ" : `Round ${data.round} (${data.round*3}å€‹æœˆ)`;
            document.getElementById('btn-next').innerText = `é€²å…¥ Round ${data.round+1}`;
            
            let statusTag = document.getElementById('status-tag');
            if(data.status === 'ended') {
                statusTag.innerText = "å·²çµæŸ"; statusTag.style.background = "#d32f2f";
                document.getElementById('btn-next').style.display = 'none';
                document.getElementById('btn-stop').style.display = 'none';
            } else {
                statusTag.innerText = "é€²è¡Œä¸­"; statusTag.style.background = "#2e7d32";
                document.getElementById('btn-next').style.display = 'block';
                document.getElementById('btn-stop').style.display = 'block';
            }

            renderMarket(data.market);
            renderLeaderboard(data.players, data.market);
            
            if (data.lastEvent) {
                const banner = document.getElementById('news-banner');
                document.getElementById('news-title').innerText = "ğŸ”´ " + data.lastEvent.title;
                document.getElementById('news-desc').innerText = data.lastEvent.desc;
                banner.style.display = 'block';
            } else { document.getElementById('news-banner').style.display = 'none'; }
        });

        function renderMarket(market) {
            const list = document.getElementById('market-list');
            list.innerHTML = Object.keys(market).map(code => {
                const item = market[code];
                let color = '#90caf9';
                if(item.type === 'gold') color = '#fff59d';
                if(item.type === 'bond') color = '#a5d6a7';
                
                let change = item.change || 0;
                let pct = item.changePercent || 0;
                let changeColor = change > 0 ? "up" : (change < 0 ? "down" : "");
                let displayChange = change !== 0 ? `<span class="${changeColor}" style="font-size:12px;">${pct.toFixed(1)}%</span>` : ``;

                return `<div class="stat-box"><div style="flex:1"><span class="tag" style="background:${color}">${item.name}</span></div><div style="text-align:right;"><div style="font-weight:bold">$${item.price.toFixed(2)}</div>${displayChange}</div></div>`;
            }).join('');
        }

        function renderLeaderboard(players, market) {
            const list = document.getElementById('leaderboard');
            let ranking = Object.values(players).map(p => {
                let stockVal = 0;
                for(let code in p.portfolio) if(market[code]) stockVal += p.portfolio[code] * market[code].price;
                
                // åŠ ç¸½å®šå­˜æœ¬é‡‘
                let depositTotal = 0;
                if(p.deposits) p.deposits.forEach(d => depositTotal += d.amount);

                return { ...p, stockVal, total: p.cash + depositTotal + stockVal };
            }).sort((a, b) => b.total - a.total);

            list.innerHTML = ranking.map((p, i) => `
                <div class="player-row rank-${i+1}">
                    <div>
                        <span style="font-size: 1.2em; font-weight: bold;">#${i+1} ${p.name}</span>
                        <div style="color: #aaa; font-size: 0.9em;">
                            ç¾é‡‘: $${Math.floor(p.cash).toLocaleString()} | 
                            å®šå­˜: $${Math.floor(p.deposits ? p.deposits.reduce((sum,d)=>sum+d.amount,0) : 0).toLocaleString()} | 
                            è­‰åˆ¸: $${Math.floor(p.stockVal).toLocaleString()}
                        </div>
                    </div>
                    <div style="font-size: 1.5em; font-weight: bold;">$${Math.floor(p.total).toLocaleString()}</div>
                </div>`).join('');
        }
    </script>
</body>
</html>