<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <title>æ§åˆ¶å°</title>
    <style>
        :root {
            --mac-bg: #1e1e1e;
            --mac-sidebar: #252526;
            --mac-item: #333333;
            --mac-text: #eeeeee;
            --mac-blue: #0a84ff;
        }
        body { font-family: -apple-system, sans-serif; background: var(--mac-bg); color: var(--mac-text); display: flex; height: 100vh; margin: 0; }
        
        .sidebar { width: 300px; padding: 20px; background: var(--mac-sidebar); border-right: 1px solid #000; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        
        h2, h3 { color: #fff; font-weight: 600; margin-bottom: 10px; }

        .stat-box { background: var(--mac-item); padding: 10px; margin-bottom: 8px; border-radius: 6px; display: flex; justify-content: space-between; font-size: 13px; align-items: center; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: black; font-weight: bold; margin-right: 8px;}
        
        .player-row { 
            background: var(--mac-item); 
            margin-bottom: 12px; padding: 15px; 
            border-radius: 10px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-left: 4px solid transparent; 
            transition: transform 0.2s;
        }
        .rank-1 { border-left-color: #ffd700; background: #443e2a; } 
        .rank-2 { border-left-color: #c0c0c0; } 
        .rank-3 { border-left-color: #cd7f32; }
        
        button { width: 100%; padding: 12px; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin-bottom: 8px; font-weight: 600; transition: filter 0.2s;}
        button:hover { filter: brightness(1.1); }
        .btn-next { background: var(--mac-blue); }
        .btn-stop { background: #ff9f0a; color: black; }
        .btn-reset { background: #ff453a; margin-top: auto; }
        
        .up { color: #32d74b; } .down { color: #ff453a; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #login-box { background: #2c2c2e; padding: 30px; border-radius: 16px; text-align: center; width: 300px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        #login-pass { width: 90%; padding: 12px; margin-bottom: 15px; font-size: 16px; border-radius: 8px; border: none; background: #1c1c1e; color: white; outline: none; text-align: center;}
    </style>
</head>
<body>
    <div id="login-overlay">
        <div id="login-box">
            <h3>ç®¡ç†å“¡ç™»å…¥</h3>
            <input type="password" id="login-pass" placeholder="Password">
            <button class="btn-next" onclick="attemptLogin()">Enter</button>
            <div id="login-err" style="color:#ff453a; display:none; margin-top:10px; font-size:13px;">å¯†ç¢¼éŒ¯èª¤</div>
        </div>
    </div>

    <div class="sidebar">
        <h2 id="round-title">æº–å‚™éšæ®µ</h2>
        <div style="font-size: 12px; color: #888; margin-bottom: 10px;">æ§åˆ¶é¢æ¿</div>
        
        <button class="btn-next" onclick="socket.emit('next_round_action')" id="btn-next">é–‹å§‹ Round 1</button>
        <button class="btn-stop" onclick="if(confirm('ç¢ºå®šè¦çµæŸéŠæˆ²å—ï¼Ÿ')) socket.emit('end_game_action')" id="btn-stop">çµæŸéŠæˆ²</button>

        <h3 style="margin-top: 20px; font-size: 14px; text-transform: uppercase; color: #666;">å¸‚å ´ç›£æ§</h3>
        <div id="market-list"></div>
        
        <button class="btn-reset" onclick="if(confirm('è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰æ•¸æ“šä¸¦é‡å•Ÿã€‚ç¢ºå®š?')) socket.emit('reset_game')">é‡ç½®ç³»çµ±</button>
    </div>

    <div class="main">
        <div id="news-banner" style="background: #ff3b30; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
            <div id="news-title" style="font-weight: bold; font-size: 18px;">NEWS</div>
            <div id="news-desc">...</div>
        </div>
        <h2>å¯¦æ™‚æ’è¡Œæ¦œ <span id="status-tag" style="font-size:12px; background:#3a3a3c; padding:4px 8px; border-radius:6px; color: #888;">ç­‰å¾…ä¸­</span></h2>
        <div id="leaderboard"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        function attemptLogin() {
            const pass = document.getElementById('login-pass').value;
            socket.emit('join_game', 'host', pass);
        }

        socket.on('host_login_success', () => { document.getElementById('login-overlay').style.display = 'none'; });
        socket.on('error_msg', (msg) => { document.getElementById('login-err').style.display = 'block'; document.getElementById('login-err').innerText = msg; });

        socket.on('host_update', (data) => {
            document.getElementById('round-title').innerText = data.round === 0 ? "æº–å‚™éšæ®µ" : `Round ${data.round} (${data.round*3}m)`;
            document.getElementById('btn-next').innerText = `é€²å…¥ Round ${data.round+1}`;
            
            let statusTag = document.getElementById('status-tag');
            if(data.status === 'ended') {
                statusTag.innerText = "å·²çµæŸ"; statusTag.style.color = "#ff453a";
                document.getElementById('btn-next').style.display = 'none';
                document.getElementById('btn-stop').style.display = 'none';
            } else {
                statusTag.innerText = "é€²è¡Œä¸­"; statusTag.style.color = "#32d74b";
                document.getElementById('btn-next').style.display = 'block';
                document.getElementById('btn-stop').style.display = 'block';
            }

            renderMarket(data.market);
            renderLeaderboard(data.players, data.market);
            
            if (data.lastEvent) {
                const banner = document.getElementById('news-banner');
                document.getElementById('news-title').innerText = "ğŸ”´ " + data.lastEvent.title;
                document.getElementById('news-desc').innerText = data.lastEvent.desc;
                banner.style.display = 'block';
            } else { document.getElementById('news-banner').style.display = 'none'; }
        });

        function renderMarket(market) {
            const list = document.getElementById('market-list');
            list.innerHTML = Object.keys(market).map(code => {
                const item = market[code];
                let color = '#0a84ff';
                if(item.type === 'gold') color = '#ffd60a';
                if(item.type === 'bond') color = '#32d74b';
                
                let change = item.change || 0;
                let pct = item.changePercent || 0;
                let changeColor = change > 0 ? "up" : (change < 0 ? "down" : "");
                let displayChange = change !== 0 ? `<span class="${changeColor}" style="font-size:11px;">${pct.toFixed(1)}%</span>` : ``;

                return `<div class="stat-box"><div style="flex:1"><span class="tag" style="background:${color}">${item.name}</span></div><div style="text-align:right;"><div style="font-weight:bold">$${item.price.toFixed(2)}</div>${displayChange}</div></div>`;
            }).join('');
        }

        function renderLeaderboard(players, market) {
            const list = document.getElementById('leaderboard');
            let ranking = Object.values(players).map(p => {
                let stockVal = 0;
                for(let code in p.portfolio) if(market[code]) stockVal += p.portfolio[code] * market[code].price;
                let depositTotal = 0;
                if(p.deposits) p.deposits.forEach(d => depositTotal += d.amount);
                return { ...p, stockVal, total: p.cash + depositTotal + stockVal };
            }).sort((a, b) => b.total - a.total);

            list.innerHTML = ranking.map((p, i) => `
                <div class="player-row rank-${i+1}">
                    <div>
                        <span style="font-size: 16px; font-weight: 600; color:white;">#${i+1} ${p.name}</span>
                        <div style="color: #aaa; font-size: 12px; margin-top:4px;">
                            ç¾é‡‘: $${Math.floor(p.cash).toLocaleString()} | 
                            å®šå­˜: $${Math.floor(p.deposits ? p.deposits.reduce((sum,d)=>sum+d.amount,0) : 0).toLocaleString()} | 
                            è­‰åˆ¸: $${Math.floor(p.stockVal).toLocaleString()}
                        </div>
                    </div>
                    <div style="font-size: 20px; font-weight: bold; color:white;">$${Math.floor(p.total).toLocaleString()}</div>
                </div>`).join('');
        }
    </script>
</body>
</html>